<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>ê³ ì••ê°€ìŠ¤ íŠ¹ì •ì„¤ë¹„ ì •ë³´ì„¼í„°</title>
    <link rel="stylesheet" href="../styles/home_styles.css">
    <link rel="stylesheet" href="../styles/common_chatbot.css">
</head>
<body>
    <div class="container">
        <div class="page-title">íŠ¹ì •ì„¤ë¹„ QR ì •ë³´ì¡°íšŒ</div>

        <div style="text-align: center; margin: 16px 0;">
            <img src="../images/home_logo.png" alt="ë¡œê³ " style="width: 220px; max-width: 80%; height: auto;" />
        </div>

        <div class="search-box-bar-naver" style="margin: 20px 16px 0 16px; border: 1px solid #4A90E2;">
            <input autocomplete="off" id="searchInput" placeholder="QR ë²ˆí˜¸ ë˜ëŠ” ê´€ë¦¬ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”." type="text"/>
            <button id="clearButton" style="position:absolute; right:60px; background:none; border:none; font-size:18px; color:#aaa; display:none; cursor:pointer;">âœ•</button>
            <button onclick="search()" style="background:none; border:none; padding:0; cursor:pointer;">
                <svg fill="none" height="28" stroke="#4A90E2" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" style="background:none; box-shadow:none;" viewbox="0 0 24 24" width="28" xmlns="http://www.w3.org/2000/svg">
                    <path d="m21 21-4.34-4.34"></path>
                    <circle cx="11" cy="11" r="8"></circle>
                </svg>
            </button>
        </div>

        <div id="recent-searches-container" style="margin: 4px 16px 0 16px; background: white; border: 1px solid #ccc; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); font-size: 14px; display: none; overflow: hidden;">
            <ul id="recent-searches-list" style="list-style: none; margin: 0; padding: 8px 0;"></ul>
            <div style="border-top: 1px solid #eee; padding: 6px 10px; display: flex; justify-content: space-between;">
                <span onclick="clearRecentSearches()" style="color:#1472b6; cursor:pointer;">ì „ì²´ ì‚­ì œ</span>
                <span onclick="hideRecentSearches()" style="color:#999; cursor:pointer;">ìµœê·¼ê²€ìƒ‰ì–´ ë‹«ê¸°</span>
            </div>
        </div>
    </div>

    <!-- ì±—ë´‡ ì»´í¬ë„ŒíŠ¸ ë¡œë“œ -->
    <div id="chatbot-container"></div>
    
    <!-- ê³µí†µ ì»´í¬ë„ŒíŠ¸ ë¡œë“œ -->
    <script src="../scripts/common_loader.js"></script>
    
    <script src="../scripts/home_script.js"></script>
    <script>
        // ì±—ë´‡ ì»´í¬ë„ŒíŠ¸ ë¡œë“œ
        fetch('../components/chatbot.html')
            .then(response => response.text())
            .then(html => {
                document.getElementById('chatbot-container').innerHTML = html;
                
                // DOM ì‚½ì… í›„ ì ì‹œ ëŒ€ê¸°
                setTimeout(() => {
                    // ìš°ì„  ê¸°ë³¸ íŒ¨ë„ ì´ë²¤íŠ¸ ë°”ì¸ë”© (ì¦‰ì‹œ ì‘ë™ ë³´ì¥)
                    setupBasicPanelEvents();
                    
                    // ê¸°ë³¸ ì›°ì»´ì¹´ë“œ ì¦‰ì‹œ ë Œë”ë§
                    renderBasicWelcomeCards();
                    
                    // ê¸°ë³¸ ì…ë ¥ ì´ë²¤íŠ¸ ë°”ì¸ë”© (ì¦‰ì‹œ ì‘ë™ ë³´ì¥)
                    setupBasicInputEvents();
                    
                    // ê·¸ ë‹¤ìŒ V2 ì‹œìŠ¤í…œ ë¡œë“œ
                    const qnaStoreScript = document.createElement('script');
                    qnaStoreScript.src = '../scripts/chatbot/qnaStore.js';
                    qnaStoreScript.onload = function() {
                        const initScript = document.createElement('script');
                        initScript.type = 'module';
                        initScript.src = '../scripts/chatbot/chatbotInit.js';
                        
                        // V2 ë¡œë”© ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ ê¸°ëŠ¥ ìœ ì§€
                        initScript.onerror = function() {
                            console.warn('V2 ì´ˆê¸°í™” ì‹¤íŒ¨, ê¸°ë³¸ ê¸°ëŠ¥ë§Œ ì‚¬ìš©');
                        };
                        
                        document.head.appendChild(initScript);
                    };
                    document.head.appendChild(qnaStoreScript);
                }, 100); // 100ms ëŒ€ê¸° í›„ ì‹¤í–‰
            })
            .catch(error => console.error('ì±—ë´‡ ì»´í¬ë„ŒíŠ¸ ë¡œë“œ ì‹¤íŒ¨:', error));
        
        // ê¸°ë³¸ íŒ¨ë„ ì´ë²¤íŠ¸ í•¨ìˆ˜ (V1 ë°©ì‹ê³¼ ë™ì¼)
        function setupBasicPanelEvents() {
            const chatbotBtn = document.getElementById("chatbot-button");
            const chatbotPanel = document.getElementById("chatbot-panel");
            const chatbotClose = document.getElementById("chatbot-close");
            
            console.log('ì±—ë´‡ DOM ìš”ì†Œ í™•ì¸:', {
                button: !!chatbotBtn,
                panel: !!chatbotPanel,
                close: !!chatbotClose
            });
            
            if (chatbotBtn && chatbotPanel) {
                console.log('[ê¸°ë³¸ëª¨ë“œ] ì±—ë´‡ íŒ¨ë„ ì´ë²¤íŠ¸ ë°”ì¸ë”© ì™„ë£Œ');
                
                // ê¸°ì¡´ ì´ë²¤íŠ¸ ì œê±° (ì¤‘ë³µ ë°©ì§€)
                chatbotBtn.onclick = null;
                
                // ìƒˆ ì´ë²¤íŠ¸ ë°”ì¸ë”© (V1ê³¼ ë™ì¼í•œ ë°©ì‹)
                chatbotBtn.addEventListener("click", function() {
                    console.log('[ê¸°ë³¸ëª¨ë“œ] ì±—ë´‡ ë²„íŠ¼ í´ë¦­ë¨');
                    chatbotPanel.style.display = "flex";
                    requestAnimationFrame(() => {
                        chatbotPanel.classList.add("is-open");
                    });
                });
                
                if (chatbotClose) {
                    chatbotClose.onclick = null;
                    chatbotClose.addEventListener("click", function() {
                        console.log('[ê¸°ë³¸ëª¨ë“œ] ì±—ë´‡ ë‹«ê¸° ë²„íŠ¼ í´ë¦­ë¨');
                        chatbotPanel.classList.remove("is-open");
                        setTimeout(() => {
                            if (!chatbotPanel.classList.contains("is-open")) {
                                chatbotPanel.style.display = "none";
                            }
                        }, 250);
                    });
                }
            } else {
                console.error('[ê¸°ë³¸ëª¨ë“œ] ì±—ë´‡ DOM ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ:', {
                    chatbotBtn, chatbotPanel, chatbotClose
                });
            }
        }
        
        // ê¸°ë³¸ ì›°ì»´ì¹´ë“œ ë Œë”ë§ í•¨ìˆ˜
        function renderBasicWelcomeCards() {
            const stream = document.getElementById("chatbot-stream");
            if (!stream) {
                console.error('ì±—ë´‡ ìŠ¤íŠ¸ë¦¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ');
                return;
            }
            
            console.log('[ê¸°ë³¸ëª¨ë“œ] ì›°ì»´ì¹´ë“œ ë Œë”ë§ ì‹œì‘');
            
            const welcomeMessages = [
                "ì•ˆë…•í•˜ì„¸ìš” ğŸ™‚ ì €ëŠ” KGS AI ì±—ë´‡ì…ë‹ˆë‹¤.\níŠ¹ì •ì„¤ë¹„ ê²€ì‚¬Â·ì•ˆì „ ì •ë³´ë¥¼ ì•ˆë‚´í•´ë“œë ¤ìš”.",
                "í˜„ì¬ëŠ” ì‹œë²”ì‚¬ì—… ë‹¨ê³„ë¡œ,\nì••ë ¥ìš©ê¸°ì™€ ê´€ë ¨ëœ ë‚´ìš©ë§Œ ì•ˆë‚´í•´ë“œë¦½ë‹ˆë‹¤.",
                "ë³¸ ëŒ€í™” ë‚´ìš©ì€ ì„œë¹„ìŠ¤ í’ˆì§ˆ í–¥ìƒê³¼ ì›í™œí•œ\nì§€ì›ì„ ìœ„í•´ ê¸°ë¡Â·ì €ì¥ë¨ì„ ì•Œë ¤ë“œë¦½ë‹ˆë‹¤.",
                "ì•„ë˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ë³´ì‹œê±°ë‚˜\nê²€ìƒ‰ì°½ì— ê¶ê¸ˆí•œ ê±¸ ì…ë ¥í•´ ë³´ì„¸ìš” ğŸ™‚"
            ];
            
            // ì›°ì»´ ë©”ì‹œì§€ë“¤ ì¶”ê°€
            welcomeMessages.forEach(text => {
                const wrapper = document.createElement("div");
                wrapper.classList.add("chatbot-message", "bot");
                
                const content = document.createElement("div");
                content.classList.add("chatbot-content");
                
                // ì•„ë°”íƒ€
                const avatar = document.createElement("img");
                avatar.src = "../images/icon_chatbot.png";
                avatar.alt = "ì±—ë´‡";
                avatar.classList.add("chatbot-avatar");
                wrapper.appendChild(avatar);
                
                // ë§í’ì„ 
                const bubble = document.createElement("div");
                bubble.classList.add("chatbot-bubble", "bot");
                bubble.textContent = text;
                content.appendChild(bubble);
                
                // ì‹œê°„
                const time = document.createElement("div");
                time.classList.add("chatbot-time");
                time.textContent = new Date().toLocaleTimeString("ko-KR", { 
                    hour: "2-digit", 
                    minute: "2-digit",
                    hour12: false 
                });
                content.appendChild(time);
                
                wrapper.appendChild(content);
                stream.appendChild(wrapper);
            });
            
            // ì¹© ë²„íŠ¼ê³¼ ì•ˆë‚´ë¬¸ ì¶”ê°€
            stream.innerHTML += `
                <div class="chips">
                    <div class="chip">ì••ë ¥ìš©ê¸° ë²•ì • ê²€ì‚¬</div>
                    <div class="chip">ê²€ì‚¬ ì‹ ì²­ ë°©ë²•</div>
                    <div class="chip">ê²€ì‚¬ ìˆ˜ìˆ˜ë£Œ</div>
                    <div class="chip">ì•ˆì „ê´€ë¦¬ ìš”ë ¹</div>
                    <div class="chip">ê´€í•  ì§€ì‚¬ ì°¾ê¸°</div>
                    <button class="chip chip-more" id="chip-more" aria-expanded="false">ë”ë³´ê¸° â–¾</button>
                </div>
                <p style="font-size:13px; color:#666; margin-top:16px;">
                    â€» ë³¸ ì±—ë´‡ì€ ì°¸ê³ ìš© ì•ˆë‚´ ì„œë¹„ìŠ¤ì´ë©°, ë²•ì  íš¨ë ¥ì€ ì—†ìŠµë‹ˆë‹¤.<br/>
                    ì •í™•í•œ í™•ì¸ì€ ê´€í•  ì§€ì‚¬ì— ë¬¸ì˜í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.
                </p>
            `;
            
            console.log('[ê¸°ë³¸ëª¨ë“œ] ì›°ì»´ì¹´ë“œ ë Œë”ë§ ì™„ë£Œ');
        }
        
        // ê¸°ë³¸ ì…ë ¥ ì´ë²¤íŠ¸ ë°”ì¸ë”© í•¨ìˆ˜
        function setupBasicInputEvents() {
            const inputBox = document.getElementById("chatbot-input-box");
            const sendBtn = document.getElementById("chatbot-send");
            const stream = document.getElementById("chatbot-stream");
            
            console.log('ì±—ë´‡ ì…ë ¥ ìš”ì†Œ í™•ì¸:', {
                inputBox: !!inputBox,
                sendBtn: !!sendBtn,
                stream: !!stream
            });
            
            if (!inputBox || !sendBtn || !stream) {
                console.error('[ê¸°ë³¸ëª¨ë“œ] ì…ë ¥ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
                return;
            }
            
            console.log('[ê¸°ë³¸ëª¨ë“œ] ì…ë ¥ ì´ë²¤íŠ¸ ë°”ì¸ë”© ì™„ë£Œ');
            
            // ë©”ì‹œì§€ ìƒì„± í•¨ìˆ˜
            function createBasicMessage(role, text) {
                return {
                    id: Date.now(),
                    role: role,
                    text: text,
                    createdAt: Date.now()
                };
            }
            
            // ë©”ì‹œì§€ ì¶”ê°€ í•¨ìˆ˜
            function appendBasicMessage(message) {
                const wrapper = document.createElement("div");
                wrapper.classList.add("chatbot-message", message.role);
                
                const content = document.createElement("div");
                content.classList.add("chatbot-content");
                
                // ë´‡ ë©”ì‹œì§€ë©´ ì•„ë°”íƒ€ ì¶”ê°€
                if (message.role === "bot") {
                    const avatar = document.createElement("img");
                    avatar.src = "../images/icon_chatbot.png";
                    avatar.alt = "ì±—ë´‡";
                    avatar.classList.add("chatbot-avatar");
                    wrapper.appendChild(avatar);
                }
                
                // ë§í’ì„ 
                const bubble = document.createElement("div");
                bubble.classList.add("chatbot-bubble", message.role);
                bubble.textContent = message.text;
                content.appendChild(bubble);
                
                // ì‹œê°„
                const time = document.createElement("div");
                time.classList.add("chatbot-time");
                time.textContent = new Date(message.createdAt).toLocaleTimeString("ko-KR", { 
                    hour: "2-digit", 
                    minute: "2-digit",
                    hour12: false 
                });
                content.appendChild(time);
                
                wrapper.appendChild(content);
                stream.appendChild(wrapper);
                
                // ìŠ¤í¬ë¡¤ ë³´ì •
                const scroller = document.querySelector('.chatbot-body');
                if (scroller) {
                    requestAnimationFrame(() => {
                        scroller.scrollTo({
                            top: scroller.scrollHeight,
                            behavior: 'smooth'
                        });
                    });
                }
            }
            
            // ì‚¬ìš©ì ì…ë ¥ ì²˜ë¦¬ í•¨ìˆ˜
            function handleBasicInput() {
                const text = inputBox.value.trim();
                if (!text) return;
                
                console.log('[ê¸°ë³¸ëª¨ë“œ] ì‚¬ìš©ì ì…ë ¥:', text);
                
                // ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
                const userMsg = createBasicMessage("user", text);
                appendBasicMessage(userMsg);
                inputBox.value = "";
                
                // V2ê°€ ì´ˆê¸°í™”ë˜ì—ˆëŠ”ì§€ í™•ì¸
                if (window.chatbotManager && window.chatbotManager.getStatus().initialized) {
                    console.log('[ê¸°ë³¸ëª¨ë“œ] V2ë¡œ ì „í™˜í•˜ì—¬ ì²˜ë¦¬');
                    // V2ê°€ ìˆìœ¼ë©´ V2ë¡œ ì²˜ë¦¬ (ì´ë¯¸ ì‚¬ìš©ì ë©”ì‹œì§€ëŠ” ì¶”ê°€ë¨)
                    return;
                }
                
                // V2ê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ ì‘ë‹µ
                setTimeout(() => {
                    const botMsg = createBasicMessage("bot", 
                        "âš ï¸ ì±—ë´‡ ì‹œìŠ¤í…œì„ ë¡œë”© ì¤‘ì…ë‹ˆë‹¤.\nì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”."
                    );
                    appendBasicMessage(botMsg);
                }, 500);
            }
            
            // ì´ë²¤íŠ¸ ë°”ì¸ë”©
            sendBtn.addEventListener('click', handleBasicInput);
            
            inputBox.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleBasicInput();
                }
            });
            
            // ì¹© ë²„íŠ¼ ì´ë²¤íŠ¸ (ì´ë²¤íŠ¸ ìœ„ì„)
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('chip') && !e.target.classList.contains('chip-more')) {
                    const chipText = e.target.textContent.trim();
                    inputBox.value = chipText;
                    handleBasicInput();
                }
            });
        }
    </script>
</body>
</html>
